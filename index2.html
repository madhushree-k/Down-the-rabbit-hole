<!DOCTYPE html>
<meta charset="utf-8">
<style>

.links line {
  stroke: #999;
  stroke-opacity: 0.6;
}

.nodes circle {
  stroke: #fff;
  stroke-width: 1.0px;
}

</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

//Constants for the SVG
var width = 500,
    height = 500;

//Set up the colour scale
var color = d3.scale.category20();

//Set up the force layout
var force = d3.layout.force()
    .charge(-120)
    .linkDistance(30)
    .size([width, height]);

//Append a SVG to the body of the html page. Assign this SVG as an object to svg
var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
.on("dblclick", threshold);

//Read the data from the mis element 
var mis = document.getElementById('mis').innerHTML;
graph = JSON.parse(mis);
graphRec=JSON.parse(JSON.stringify(graph)); //Add this line

//Creates the graph data structure out of the json data
force.nodes(graph.nodes)
    .links(graph.links)
    .start();

//Create all the line svgs but without locations yet
var link = svg.selectAll(".link")
    .data(graph.links)
    .enter().append("line")
    .attr("class", "link")
    .style("stroke-width", function (d) {
    return Math.sqrt(d.value);
});

//Do the same with the circles for the nodes - no 
var node = svg.selectAll(".node")
    .data(graph.nodes)
    .enter().append("circle")
    .attr("class", "node")
    .attr("r", 8)
    .style("fill", function (d) {
    return color(d.group);
})
    .call(force.drag);


//Now we are giving the SVGs co-ordinates - the force layout is generating the co-ordinates which this code is using to update the attributes of the SVG elements
force.on("tick", function () {
    link.attr("x1", function (d) {
        return d.source.x;
    })
        .attr("y1", function (d) {
        return d.source.y;
    })
        .attr("x2", function (d) {
        return d.target.x;
    })
        .attr("y2", function (d) {
        return d.target.y;
    });

    node.attr("cx", function (d) {
        return d.x;
    })
        .attr("cy", function (d) {
        return d.y;
    });
});


//---Insert-------

//adjust threshold

function threshold(thresh) {
    graph.links.splice(0, graph.links.length);

		for (var i = 0; i < graphRec.links.length; i++) {
			if (graphRec.links[i].value > thresh) {graph.links.push(graphRec.links[i]);}
		}
    restart();
}


//Restart the visualisation after any node and link changes

function restart() {
	
	link = link.data(graph.links);
	link.exit().remove();
	link.enter().insert("line", ".node").attr("class", "link");
	node = node.data(graph.nodes);
	node.enter().insert("circle", ".cursor").attr("class", "node").attr("r", 5).call(force.drag);
	force.start();
}
//---End Insert---
</script>  

<script type="application/json" id="mis">
	{
       "nodes": [
    {"id": "Alice", "group": 1},
    {"id": "Hatter", "group": 3},
    {"id": "Caterpillar", "group": 4},
    {"id": "RedQueen", "group": 2},
    {"id": "WhiteRabbit", "group": 4},
    {"id": "CheshireCat", "group": 4},
    {"id": "RedKing", "group": 2},
    {"id": "Duchess", "group": 3},
    {"id": "MockTurtle", "group": 5},
    {"id": "Knave", "group": 2},
    {"id": "Gryphon", "group": 5},
    {"id": "MarchHare", "group": 4},
    {"id": "Sister", "group": 1},
    {"id": "Dormouse", "group": 4}
    
  ],
  "links": [
    {"source": "10", "target": "2", "value": 20},
    {"source": "Alice", "target": "Caterpillar", "value": 17},
    {"source": "Alice", "target": "RedQueen", "value": 18},
    {"source": "Alice", "target": "WhiteRabbit", "value": 6},
    {"source": "Alice", "target": "CheshireCat", "value": 15},
    {"source": "Alice", "target": "RedKing", "value": 8},
    {"source": "Alice", "target": "Duchess", "value": 17},
    {"source": "Alice", "target": "MockTurtle", "value": 31},
    {"source": "Alice", "target": "Knave", "value": 1},
    {"source": "Alice", "target": "Gryphon", "value": 22},
    {"source": "Alice", "target": "MarchHare", "value": 10},
    {"source": "Alice", "target": "Dormouse", "value": 12},
    {"source": "Alice", "target": "Sister", "value": 2}  
   
  ]  
}
</script>
<form>
    <h3> Link threshold 0 <input type="range" id="thersholdSlider" name="points" value = 0 min="0" max="40" onchange="threshold(this.value)"> 40 </h3>
</form>

